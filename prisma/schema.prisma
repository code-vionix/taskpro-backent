
// This is your Prisma schema file,
// learn more about it in the docs: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider  = "postgresql"
  url       = env("DATABASE_URL")
  directUrl = env("DIRECT_URL")
}

enum Role {
  ADMIN
  ASSISTANT_ADMIN
  USER
  GUEST
}

enum TaskStatus {
  PENDING
  IN_PROGRESS
  UNDER_REVIEW
  COMPLETED
  REJECTED
  EXPIRED
}

enum TaskType {
  EXAM
  PRACTICE
}

model User {
  id               String   @id @default(uuid())
  email            String   @unique
  password         String?
  name             String?
  role             Role     @default(USER)
  tasks            Task[]
  refreshToken     String?
  failedAttempts   Int       @default(0)
  lockoutUntil     DateTime?
  createdAt        DateTime  @default(now())
  updatedAt        DateTime  @updatedAt
  bio              String?
  address          String?
  education        String?
  avatarUrl        String?
  coverImageUrl     String?
  coverPosition    Json?
  avatarPosition   Json?
  isOnline         Boolean   @default(false)
  lastSeen         DateTime? @default(now())
  
  // Permissions managed by ADMIN
  canPost          Boolean   @default(true)
  canMessage       Boolean   @default(true)
  canUseCommunity  Boolean   @default(true)
  canCreateTask    Boolean   @default(true)

  posts            Post[]
  comments         Comment[]
  reactions        Reaction[]
  sentMessages     Message[] @relation("SentMessages")
  receivedMessages Message[] @relation("ReceivedMessages")
  notifications    Notification[]
  messageReactions MessageReaction[]
  taskComments     TaskComment[]
  otp              String?
  otpExpires        DateTime?

  // Follow System
  followers        Follow[]  @relation("UserFollowers")
  following        Follow[]  @relation("UserFollowing")

  // Category System
  category           String?   // WEB_DEV, SOCIAL_MEDIA, etc.
  lastCategoryUpdate DateTime? // Monthly change limit
}

model Follow {
  id          String   @id @default(uuid())
  followerId  String
  follower    User     @relation("UserFollowing", fields: [followerId], references: [id])
  followingId String
  following   User     @relation("UserFollowers", fields: [followingId], references: [id])
  createdAt   DateTime @default(now())

  @@unique([followerId, followingId])
}

enum TaskPriority {
  LOW
  MEDIUM
  HIGH
  URGENT
}

model Task {
  id            String        @id @default(uuid())
  title         String
  description   String?
  startTime     DateTime
  endTime       DateTime
  isStopped     Boolean       @default(false)
  status        TaskStatus    @default(PENDING)
  type          TaskType      @default(PRACTICE)
  priority      TaskPriority  @default(MEDIUM)
  category      String        @default("GENERAL")
  tags          String[]      @default([])
  attachments   Json?         // Array of { name: string, url: string }
  duration      Int           @default(300) // Duration in seconds (default 5 mins)
  startedAt     DateTime?
  completedAt   DateTime?
  score         Int           @default(0)
  submissionNotes String?     // Summary of work done
  
  // Recurrence
  isRecurring   Boolean       @default(false)
  recurrence    String?       // DAILY, WEEKLY, MONTHLY
  
  userId        String?
  user          User?          @relation(fields: [userId], references: [id])
  subTasks      SubTask[]
  history       TaskHistory[]
  comments      TaskComment[]
  deletedAt     DateTime? // For soft delete
  createdAt     DateTime      @default(now())
  updatedAt     DateTime      @updatedAt
  lastStoppedAt DateTime?
  
  // Monitoring
  focusLosses   Int           @default(0)
  activityLogs  Json?         @default("[]") // Array of { type: string, timestamp: string, url?: string, duration?: number }
}

model TaskComment {
  id        String   @id @default(uuid())
  content   String
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  createdAt DateTime @default(now())
}

model SubTask {
  id          String   @id @default(uuid())
  title       String
  description String?
  isCompleted Boolean  @default(false)
  taskId      String
  task        Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
  subSubTasks SubSubTask[]
}

model SubSubTask {
  id          String   @id @default(uuid())
  title       String
  description String?
  isCompleted Boolean  @default(false)
  subTaskId   String
  subTask     SubTask  @relation(fields: [subTaskId], references: [id], onDelete: Cascade)
  createdAt   DateTime @default(now())
  updatedAt   DateTime @updatedAt
}

model TaskHistory {
  id        String   @id @default(uuid())
  taskId    String
  task      Task     @relation(fields: [taskId], references: [id], onDelete: Cascade)
  action    String   // e.g., "UPDATE", "SOFT_DELETE"
  details   Json
  createdAt DateTime @default(now())
}

model Post {
  id        String   @id @default(uuid())
  content   String?
  imageUrl  String?
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  comments  Comment[]
  reactions Reaction[]
  sharedPostId String?
  sharedPost   Post?    @relation("PostShares", fields: [sharedPostId], references: [id])
  shares       Post[]   @relation("PostShares")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Comment {
  id        String   @id @default(uuid())
  content   String
  postId    String
  post      Post     @relation(fields: [postId], references: [id], onDelete: Cascade)
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  parentId  String?
  parent    Comment?  @relation("CommentReplies", fields: [parentId], references: [id])
  replies   Comment[] @relation("CommentReplies")
  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

enum ReactionType {
  LIKE
  DISLIKE
  LOVE
}

model Reaction {
  id        String       @id @default(uuid())
  type      ReactionType
  userId    String
  user      User         @relation(fields: [userId], references: [id])
  postId    String
  post      Post         @relation(fields: [postId], references: [id], onDelete: Cascade)
  createdAt DateTime     @default(now())

  @@unique([userId, postId])
}

model Message {
  id        String   @id @default(uuid())
  content   String
  senderId  String
  sender    User     @relation("SentMessages", fields: [senderId], references: [id])
  receiverId String
  receiver  User     @relation("ReceivedMessages", fields: [receiverId], references: [id])
  isRead    Boolean  @default(false)
  reactions MessageReaction[]
  createdAt DateTime @default(now())
}

model MessageReaction {
  id        String   @id @default(uuid())
  type      String   // LIKE, LOVE, HAHA, WOW, SAD, ANGRY
  userId    String
  user      User     @relation(fields: [userId], references: [id])
  messageId String
  message   Message  @relation(fields: [messageId], references: [id], onDelete: Cascade)
  createdAt DateTime @default(now())

  @@unique([userId, messageId])
}

model Notification {
  id        String   @id @default(uuid())
  type      String   // MESSAGE, COMMENT, REACTION, TASK_ASSIGNED, FOLLOW
  message   String
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  isRead    Boolean  @default(false)
  data      Json?    // Optional data like link, postId, etc.
  createdAt DateTime @default(now())
}
